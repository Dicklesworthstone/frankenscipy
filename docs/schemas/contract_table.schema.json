{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://frankenscipy.local/schemas/contract_table.schema.json",
  "title": "FrankenSciPy Contract Table",
  "description": "Schema for per-packet contract tables used by -B beads. Each contract entry specifies the input/output/error semantics, tolerance policy, and strict/hardened mode behaviors for a scoped function.",
  "type": "object",
  "required": ["schema_version", "packet_id", "domain", "contracts"],
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "type": "integer",
      "const": 1,
      "description": "Schema version for forward-compatibility gating."
    },
    "packet_id": {
      "type": "string",
      "pattern": "^FSCI-P2C-\\d{3}$",
      "description": "Packet identifier, e.g. FSCI-P2C-002."
    },
    "domain": {
      "type": "string",
      "enum": ["integrate", "linalg", "optimize", "sparse", "fft", "special", "stats", "signal", "spatial", "interpolate", "ndimage", "io", "cluster", "constants", "misc", "odr", "datasets", "differentiate", "arrayapi", "conformance"],
      "description": "Domain family this contract table covers."
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 timestamp of contract table generation."
    },
    "contracts": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/ContractEntry"
      }
    }
  },
  "$defs": {
    "ContractEntry": {
      "type": "object",
      "required": [
        "function_name",
        "inputs",
        "outputs",
        "error_conditions",
        "tolerance_policy",
        "strict_mode_behavior",
        "hardened_mode_behavior"
      ],
      "additionalProperties": false,
      "properties": {
        "function_name": {
          "type": "string",
          "description": "Fully qualified function name in the target Rust crate."
        },
        "scipy_equivalent": {
          "type": "string",
          "description": "Corresponding SciPy function, e.g. scipy.linalg.solve."
        },
        "inputs": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/ParamSpec"
          },
          "description": "Ordered list of input parameters."
        },
        "outputs": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/OutputSpec"
          },
          "description": "Ordered list of output fields."
        },
        "error_conditions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/ErrorCondition"
          },
          "description": "Exhaustive list of error conditions and their triggers."
        },
        "tolerance_policy": {
          "$ref": "#/$defs/TolerancePolicy",
          "description": "Tolerance semantics for numeric comparison."
        },
        "backend_semantics": {
          "type": "string",
          "description": "Backend routing or selection semantics, if applicable."
        },
        "strict_mode_behavior": {
          "type": "string",
          "minLength": 5,
          "description": "Observable behavior in strict mode."
        },
        "hardened_mode_behavior": {
          "type": "string",
          "minLength": 5,
          "description": "Observable behavior in hardened mode, including defensive checks."
        },
        "invariants": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Machine-checkable invariants that must hold across modes."
        },
        "performance_sentinel": {
          "type": "string",
          "description": "Performance budget reference from COMPREHENSIVE_SPEC section 17."
        }
      }
    },
    "ParamSpec": {
      "type": "object",
      "required": ["name", "type_desc", "required"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Parameter name."
        },
        "type_desc": {
          "type": "string",
          "description": "Type description (e.g. '2D array f64', 'bool', 'Option<MatrixAssumption>')."
        },
        "required": {
          "type": "boolean",
          "description": "Whether the parameter is required."
        },
        "default_value": {
          "type": "string",
          "description": "Default value if optional, as a string representation."
        },
        "constraints": {
          "type": "string",
          "description": "Value constraints or domain restrictions."
        }
      }
    },
    "OutputSpec": {
      "type": "object",
      "required": ["name", "type_desc"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Output field name."
        },
        "type_desc": {
          "type": "string",
          "description": "Type description of the output."
        },
        "semantics": {
          "type": "string",
          "description": "Semantic meaning and guarantees."
        }
      }
    },
    "ErrorCondition": {
      "type": "object",
      "required": ["condition", "error_type", "message_pattern"],
      "additionalProperties": false,
      "properties": {
        "condition": {
          "type": "string",
          "description": "Trigger condition for the error."
        },
        "error_type": {
          "type": "string",
          "description": "Error variant name in the Rust error enum."
        },
        "message_pattern": {
          "type": "string",
          "description": "Expected error message pattern for conformance matching."
        },
        "scipy_behavior": {
          "type": "string",
          "description": "Corresponding SciPy error/exception behavior."
        }
      }
    },
    "TolerancePolicy": {
      "type": "object",
      "required": ["comparison_mode"],
      "additionalProperties": false,
      "properties": {
        "comparison_mode": {
          "type": "string",
          "enum": ["absolute", "relative", "mixed", "exact", "not_applicable"],
          "description": "How numeric outputs are compared in conformance tests."
        },
        "default_atol": {
          "type": "number",
          "minimum": 0,
          "description": "Default absolute tolerance."
        },
        "default_rtol": {
          "type": "number",
          "minimum": 0,
          "description": "Default relative tolerance."
        },
        "notes": {
          "type": "string",
          "description": "Additional tolerance semantics or caveats."
        }
      }
    }
  }
}
